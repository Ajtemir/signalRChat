#pragma checksum "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "098ff1f52476a2eda02fd03e7a0b347167407176"
// <auto-generated/>
#pragma warning disable 1591
[assembly: global::Microsoft.AspNetCore.Razor.Hosting.RazorCompiledItemAttribute(typeof(AspNetCore.Views_Home_Index), @"mvc.1.0.view", @"/Views/Home/Index.cshtml")]
namespace AspNetCore
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Mvc;
    using Microsoft.AspNetCore.Mvc.Rendering;
    using Microsoft.AspNetCore.Mvc.ViewFeatures;
#nullable restore
#line 1 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/_ViewImports.cshtml"
using FSHomeWork;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/_ViewImports.cshtml"
using FSHomeWork.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 1 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml"
using FSHomeWork.Models.Entities;

#line default
#line hidden
#nullable disable
    [global::Microsoft.AspNetCore.Razor.Hosting.RazorSourceChecksumAttribute(@"SHA1", @"098ff1f52476a2eda02fd03e7a0b347167407176", @"/Views/Home/Index.cshtml")]
    [global::Microsoft.AspNetCore.Razor.Hosting.RazorSourceChecksumAttribute(@"SHA1", @"ba8bb141b48e9c3b3805df8fa8833f1ac7471e8b", @"/Views/_ViewImports.cshtml")]
    public class Views_Home_Index : global::Microsoft.AspNetCore.Mvc.Razor.RazorPage<dynamic>
    {
        #pragma warning disable 1998
        public async override global::System.Threading.Tasks.Task ExecuteAsync()
        {
#nullable restore
#line 2 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml"
  
    ViewData["Title"] = "Home Page";

#line default
#line hidden
#nullable disable
            WriteLiteral("\n");
            WriteLiteral(@"
<div id=""loginBlock"" data-bind=""ifnot:isAuthenticated"">
    Введите почту:
    <br />
    <input id=""email"" type=""text"" data-bind=""textInput:email""/>
    <br />
    Введите пароль:
    <br />
    <input id=""password"" type=""password"" data-bind=""textInput:password""/>
    <br />
    <input id=""loginBtn"" type=""button"" value=""Войти"" />
</div>
<div id=""listOfUsersBlock"" data-bind=""if:isAuthenticated"">
");
#nullable restore
#line 23 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml"
     foreach (User user in ViewBag.Users)
    {

#line default
#line hidden
#nullable disable
            WriteLiteral("        <button");
            BeginWriteAttribute("id", " id=\"", 749, "\"", 766, 1);
#nullable restore
#line 25 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml"
WriteAttributeValue("", 754, user.UserId, 754, 12, false);

#line default
#line hidden
#nullable disable
            EndWriteAttribute();
            WriteLiteral(" class=\"user btn btn-primary\">\n            ");
#nullable restore
#line 26 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml"
       Write(user.Email);

#line default
#line hidden
#nullable disable
            WriteLiteral("\n        </button>\n        <br>\n");
#nullable restore
#line 29 "/home/aitemir/RiderProjects/FSHomeWork/FSHomeWork/Views/Home/Index.cshtml"


        
        
    }

#line default
#line hidden
#nullable disable
            WriteLiteral(@"</div>
<br />

 
    <div id=""header""></div><br />
 
    <div id=""inputForm"" data-bind=""if:isAuthenticated"">
        <input type=""text"" id=""message"" />
        <input type=""button"" id=""sendBtn"" value=""Отправить"" />
    </div>
    <div class=""testing"">Сообщения</div>
    <div id=""chatroom""></div>

");
            DefineSection("Scripts", async() => {
                WriteLiteral(@"
    <script >
        let token;
        const hubConnection = new signalR.HubConnectionBuilder()
                    .withUrl(""/chat"",{ accessTokenFactory: () => token})
                    // .withUrl(""/chat"",options=>{options.AccessTokenProvider = () => Task.FromResult(`${token}`);})
                    .build();
        
        hubConnection.on(""Receive"", function (message, userName) {
 
            // создаем элемент <b> для имени пользователя
            let userNameElem = document.createElement(""b"");
            userNameElem.appendChild(document.createTextNode(userName + "": ""));
 
            // создает элемент <p> для сообщения пользователя
            let elem = document.createElement(""p"");
            elem.appendChild(userNameElem);
            elem.appendChild(document.createTextNode(message));
 
            var firstElem = document.getElementById(""chatroom"").firstChild;
            document.getElementById(""chatroom"").insertBefore(elem, firstElem);
        });
        let to;
        document.get");
                WriteLiteral(@"ElementById(""sendBtn"").addEventListener(""click"", function (e) {
            console.log(""sendBtn clicked"")
            let message = document.getElementById(""message"").value;
            
            hubConnection.invoke(""Send"", message, to);
        })
        let viewModel ={
            email: ko.observable(""first@gmail.com""),
            password:ko.observable(""password""),
            accessToken:ko.observable(""""),
            isAuthenticated:ko.observable(false)
            
        };
        ko.applyBindings(viewModel);
        
        const loginBlock = document.getElementById(""loginBlock"")
        const loginButton = document.getElementById(""loginBtn"")
        const emailBlock = document.getElementById(""email"")
        let messages;
        
        
        function fetchToken(email,password){
            return fetch(""http://localhost:5000/Home/Token/"",{
               method:'POST',
               headers: {
                 'Content-Type': 'application/json',
               },
               bod");
                WriteLiteral(@"y: JSON.stringify({email:email,password:password})
           }).then(response=>{
               if(response.ok){
                   viewModel.isAuthenticated(true)
                  return response.json()
               }
               
               return response.text().then(error => {
                   const e = new Error(""Someting went wrong!!!"")
                   e.data = error
                   throw e;
               })
           })
        }
        loginButton.addEventListener(""click"", async ()=>{
            const email = document.getElementById(""email"").value;
            const password = document.getElementById(""password"").value;
            token = await fetchToken(email,password)
            .then(data=>{
                return data['token']
            }).catch(error =>{
                let fragment = document.createDocumentFragment();
                const warning = document.createTextNode(`${error.data}`);
                const escape = document.createElement(""br"");
                fr");
                WriteLiteral(@"agment.appendChild(warning)
                fragment.appendChild(escape)
                loginBlock.insertBefore(fragment,emailBlock)
                console.log(error)
                
            })
            await addUserButtonsListeners()

        })
        
        
        
         // boxes = document.querySelectorAll('.user');
         // boxes.forEach(box => {
         //    box.onclick = function(){console.log(""clicked"")};
         // });
         function showUsers(messages){
            const div = document.getElementById('chatroom');
            div.innerHTML = """";
            messages.forEach(message => {
                const fragment = document.createDocumentFragment();
                let userNameElem = document.createElement(""b"");
                userNameElem.appendChild(document.createTextNode(message.writer + "": ""));
                let elem = document.createElement(""p"");
                elem.appendChild(userNameElem);
                elem.appendChild(document.createTextNode(message.tex");
                WriteLiteral(@"t));
                div.appendChild(elem)
            })
         }
         
         async function addUserButtonsListeners(){
            const userButtons = document.getElementsByClassName(""user"")
            const bearerToken = `Bearer ${token}`
            console.log(bearerToken)
            Array.from(userButtons).forEach(function(element) {
              element.addEventListener('click', async ()=>{
                  to = element.firstChild.data.trim()
                  const url = 'http://localhost:5000/home/messages'
                  let receiverId = parseInt(element.id)
                  await fetch(url,{
                      method:""POST"",
                  body:receiverId,
                      headers:{
                          'Content-Type': 'application/json;charset=utf-8;',
                          'Authorization': bearerToken
                      }
                  }).then(async (data)=>{
                      const json = await data.json()
                      messages = json
    ");
                WriteLiteral(@"                  showUsers(json)
                      console.log(json)
                  })
              });
            });  
            
            document.getElementById(""sendBtn"").addEventListener(""click"", function (e) {
                        console.log(""sendBtn clicked"")
                        let message = document.getElementById(""message"").value;
                        
                        hubConnection.invoke(""Send"", message, to);
                    })
            hubConnection.start();
        }
    </script>
");
            }
            );
        }
        #pragma warning restore 1998
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.ViewFeatures.IModelExpressionProvider ModelExpressionProvider { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.IUrlHelper Url { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.IViewComponentHelper Component { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.Rendering.IJsonHelper Json { get; private set; }
        [global::Microsoft.AspNetCore.Mvc.Razor.Internal.RazorInjectAttribute]
        public global::Microsoft.AspNetCore.Mvc.Rendering.IHtmlHelper<dynamic> Html { get; private set; }
    }
}
#pragma warning restore 1591
